from concurrent.futures import ThreadPoolExecutor, as_completed
import time
from pyclashbot.detection.image_rec import pixel_is_equal

from pyclashbot.memu.client import screenshot
import random

CARD_PIXEL_DATA_DICT = {
    # checked
    "arrows": [
          [[56,41,207],
[235,217,188],
[236,186,124],
[237,193,139],
[183,156,159],],[[61,38,201],
[228,206,181],
[234,192,133],
[226,191,138],
[206,176,163],],[[62,37,199],
[227,205,180],
[234,192,133],
[222,187,134],
[211,181,168],],  [
            [239, 223, 196],
            [234, 213, 185],
            [237, 194, 135],
            [239, 196, 133],
            [199, 164, 124],
        ],
    ],
    "barb_hut": [
       [[144,149,110],
[229,176,122],
[161,146,149],
[121,185,243],
[61,113,179],], [[146,146,117],
[229,176,122],
[159,147,147],
[121,187,240],
[47,116,179],],[[127,133,100],
[228,171,129],
[150,134,132],
[118,122,131],
[37,44,64],],[
            [76, 72, 9],
            [210, 208, 193],
            [94, 84, 62],
            [19, 17, 10],
            [26, 33, 51],
        ],
        [
            [175, 181, 156],
            [235, 181, 136],
            [246, 226, 226],
            [110, 167, 255],
            [119, 184, 251],
        ],
        [
            [175, 181, 156],
            [236, 182, 138],
            [246, 226, 226],
            [110, 167, 255],
            [119, 185, 252],
        ],
        [
            [177, 178, 152],
            [249, 195, 151],
            [249, 230, 230],
            [110, 177, 166],
            [72, 120, 185],
        ],
        [
            [175, 181, 156],
            [238, 185, 140],
            [246, 226, 226],
            [110, 167, 255],
            [121, 187, 254],
        ],
        [
            [176, 182, 155],
            [231, 178, 132],
            [246, 226, 226],
            [110, 167, 255],
            [117, 182, 249],
        ],
    ],
    "barb_barrel": [
        [[230,166,72],
[5,159,148],
[56,91,142],
[17,50,100],
[61,52,49],],  [[229,166,75],
[10,161,153],
[51,88,139],
[19,56,102],
[62,53,50],], [[231,166,75],
[9,162,154],
[55,91,140],
[17,51,98],
[61,53,48],],  [
            [227, 171, 71],
            [84, 255, 255],
            [26, 59, 91],
            [69, 113, 170],
            [59, 55, 52],
        ],
        [
            [227, 171, 70],
            [80, 247, 250],
            [51, 88, 128],
            [47, 79, 121],
            [71, 66, 64],
        ],
        [
            [227, 171, 71],
            [83, 255, 255],
            [27, 61, 93],
            [69, 114, 171],
            [60, 56, 53],
        ],
    ],
    "balloon": [
        [[115,121,143],
[111,84,73],
[144,144,158],
[191,209,182],
[204,207,168],],[[108,127,186],
[108,78,70],
[127,142,192],
[187,215,193],
[203,203,169],],[[107,126,185],
[108,78,70],
[127,142,192],
[187,215,193],
[203,204,165],],[
            [211, 244, 233],
            [127, 95, 75],
            [85, 84, 86],
            [202, 212, 173],
            [196, 206, 158],
        ],
        [
            [50, 68, 122],
            [117, 88, 78],
            [83, 95, 122],
            [207, 225, 196],
            [203, 203, 157],
        ],
        [
            [94, 113, 166],
            [117, 88, 78],
            [83, 95, 120],
            [207, 225, 196],
            [203, 202, 154],
        ],
    ],
    "bomb_tower": [
         [[110,78,56],
[212,203,161],
[21,39,80],
[70,101,190],
[84,116,221],], [[107,77,55],
[212,203,161],
[18,36,77],
[74,105,194],
[82,114,219],],[[104,78,58],
[232,219,162],
[18,41,81],
[87,114,195],
[77,120,221],],  [
            [109, 79, 55],
            [206, 189, 141],
            [25, 43, 83],
            [33, 75, 179],
            [85, 119, 216],
        ],
        [
            [109, 79, 57],
            [222, 204, 158],
            [18, 39, 82],
            [39, 63, 152],
            [84, 116, 216],
        ],
        [
            [109, 79, 57],
            [221, 203, 155],
            [18, 39, 82],
            [39, 59, 143],
            [84, 116, 215],
        ],
        [
            [109, 79, 57],
            [222, 205, 159],
            [18, 39, 82],
            [39, 65, 156],
            [84, 116, 216],
        ],
        [
            [109, 79, 57],
            [221, 203, 153],
            [19, 39, 82],
            [39, 56, 137],
            [84, 116, 215],
        ],
    ],
    "battle_ram": [
       [[83,77,12],
[136,133,100],
[91,77,55],
[53,46,31],
[58,80,114],],[[84,79,12],
[146,131,100],
[91,78,53],
[53,46,31],
[58,80,114],], [[83,76,7],
[147,154,132],
[85,77,51],
[48,38,33],
[37,47,73],],   [[83,78,11],
[140,132,100],
[89,77,57],
[53,46,31],
[58,80,114],],[[88,80,14],
[102,85,54],
[89,78,53],
[55,42,31],
[90,104,96],],  [
            [71, 67, 12],
            [200, 187, 173],
            [74, 62, 37],
            [33, 27, 24],
            [68, 71, 84],
        ],
        [
            [82, 70, 8],
            [228, 215, 200],
            [96, 84, 65],
            [15, 11, 1],
            [31, 39, 58],
        ],
        [
            [82, 77, 8],
            [173, 164, 146],
            [91, 81, 54],
            [59, 58, 36],
            [47, 63, 86],
        ],
        [
            [82, 77, 8],
            [173, 164, 146],
            [91, 81, 54],
            [59, 58, 36],
            [47, 63, 86],
        ],
        [
            [82, 77, 8],
            [173, 164, 146],
            [91, 81, 54],
            [59, 58, 36],
            [47, 63, 86],
        ],
        [
            [82, 77, 8],
            [173, 164, 146],
            [91, 81, 54],
            [59, 58, 36],
            [47, 63, 86],
        ],
    ],
    "cannon": [
          [[124,157,168],
[167,144,164],
[45,53,52],
[192,207,210],
[201,220,231],],[[118,159,166],
[154,149,178],
[46,53,54],
[173,192,196],
[194,221,228],],  [[123,159,167],
[154,149,178],
[45,52,53],
[171,192,196],
[194,221,228],],  [
            [113, 149, 159],
            [159, 135, 156],
            [50, 58, 59],
            [34, 51, 51],
            [201, 224, 234],
        ],
        [
            [113, 148, 158],
            [155, 135, 159],
            [50, 57, 58],
            [34, 51, 51],
            [201, 224, 234],
        ],
        [
            [115, 150, 160],
            [155, 134, 158],
            [50, 58, 59],
            [35, 50, 50],
            [200, 224, 234],
        ],
    ],
    "furnace": [
          [[87,139,113],
[45,35,55],
[216,38,188],
[109,103,93],
[75,174,202],], [[91,158,134],
[32,33,51],
[232,57,218],
[98,90,78],
[16,104,131],], [[71,113,89],
[36,30,54],
[231,55,220],
[139,129,124],
[123,119,109],],   [
            [83, 140, 113],
            [49, 40, 59],
            [204, 34, 170],
            [145, 138, 128],
            [121, 108, 101],
        ],
    ],
    #unchecked
    "freeze": [
        [
            [244, 231, 188],
            [239, 232, 204],
            [126, 120, 94],
            [234, 229, 27],
            [234, 228, 223],
        ],
        [
            [245, 231, 190],
            [243, 240, 220],
            [144, 140, 104],
            [237, 229, 30],
            [223, 217, 200],
        ],
        [
            [249, 239, 193],
            [243, 239, 208],
            [104, 101, 61],
            [234, 230, 31],
            [223, 224, 219],
        ],
    ],
    "goblin_drill": [
        [
            [67, 47, 23],
            [238, 206, 178],
            [129, 120, 117],
            [112, 103, 100],
            [88, 57, 26],
        ],
        [
            [75, 49, 24],
            [225, 201, 183],
            [118, 109, 106],
            [125, 113, 113],
            [82, 62, 20],
        ],
        [
            [75, 50, 22],
            [225, 200, 184],
            [118, 109, 106],
            [125, 113, 113],
            [82, 61, 21],
        ],
        [
            [69, 48, 20],
            [223, 201, 184],
            [114, 103, 100],
            [125, 113, 113],
            [83, 62, 22],
        ],
        [
            [63, 45, 21],
            [221, 201, 177],
            [128, 116, 118],
            [117, 105, 105],
            [84, 56, 29],
        ],
        [
            [71, 48, 20],
            [228, 197, 180],
            [121, 109, 109],
            [115, 104, 101],
            [78, 56, 19],
        ],
        [
            [63, 45, 21],
            [220, 200, 176],
            [125, 113, 115],
            [117, 105, 105],
            [86, 58, 31],
        ],
        [
            [62, 44, 20],
            [221, 201, 177],
            [128, 116, 118],
            [115, 103, 103],
            [86, 58, 31],
        ],
        [
            [72, 50, 20],
            [235, 205, 183],
            [121, 109, 109],
            [117, 106, 103],
            [81, 58, 23],
        ],
    ],
    "goblin_cage": [
        [
            [116, 101, 102],
            [44, 119, 91],
            [54, 133, 114],
            [2, 41, 40],
            [182, 130, 114],
        ],
        [
            [119, 105, 103],
            [48, 118, 91],
            [50, 129, 110],
            [3, 40, 39],
            [179, 128, 109],
        ],
        [
            [111, 103, 105],
            [50, 122, 95],
            [60, 142, 127],
            [0, 36, 43],
            [189, 137, 114],
        ],
        [
            [119, 105, 103],
            [48, 118, 91],
            [50, 129, 110],
            [3, 40, 39],
            [181, 129, 113],
        ],
        [
            [115, 107, 102],
            [48, 120, 93],
            [63, 145, 130],
            [0, 34, 41],
            [193, 138, 118],
        ],
        [
            [113, 106, 103],
            [48, 120, 93],
            [65, 144, 130],
            [0, 33, 43],
            [191, 139, 116],
        ],
        [
            [115, 105, 105],
            [48, 120, 93],
            [63, 145, 130],
            [0, 33, 43],
            [191, 139, 116],
        ],
        [
            [113, 104, 101],
            [48, 120, 93],
            [66, 145, 131],
            [0, 33, 43],
            [192, 137, 117],
        ],
        [
            [111, 105, 100],
            [50, 122, 95],
            [60, 142, 127],
            [0, 36, 43],
            [191, 137, 114],
        ],
    ],
    "graveyard": [
        [
            [65, 43, 58],
            [120, 81, 106],
            [222, 210, 217],
            [64, 42, 57],
            [171, 104, 140],
        ],
        [
            [67, 45, 60],
            [120, 81, 106],
            [225, 212, 221],
            [69, 47, 64],
            [171, 104, 138],
        ],
        [
            [69, 44, 60],
            [116, 82, 106],
            [224, 212, 219],
            [66, 41, 59],
            [168, 103, 139],
        ],
        [
            [70, 51, 64],
            [101, 64, 84],
            [222, 216, 224],
            [135, 96, 109],
            [180, 110, 140],
        ],
        [
            [66, 46, 61],
            [103, 63, 86],
            [222, 216, 224],
            [135, 96, 109],
            [178, 107, 140],
        ],
        [
            [66, 44, 59],
            [120, 81, 106],
            [222, 209, 218],
            [66, 41, 57],
            [167, 105, 138],
        ],
        [
            [65, 45, 60],
            [110, 65, 89],
            [227, 224, 231],
            [126, 101, 119],
            [179, 106, 139],
        ],
        [
            [65, 46, 59],
            [102, 65, 85],
            [216, 210, 218],
            [130, 91, 104],
            [180, 110, 140],
        ],
        [
            [54, 38, 50],
            [121, 82, 100],
            [229, 217, 229],
            [84, 59, 70],
            [180, 110, 140],
        ],
        [
            [58, 38, 48],
            [121, 82, 100],
            [227, 218, 229],
            [89, 62, 73],
            [180, 110, 140],
        ],
        [
            [66, 45, 57],
            [168, 96, 148],
            [242, 238, 250],
            [130, 86, 108],
            [185, 111, 144],
        ],
        [
            [76, 60, 72],
            [114, 68, 106],
            [254, 249, 254],
            [33, 16, 24],
            [124, 81, 115],
        ],
        [
            [64, 45, 58],
            [111, 65, 91],
            [226, 220, 228],
            [126, 101, 117],
            [181, 106, 139],
        ],
    ],
    "goblin_barrel": [
        [
            [159, 186, 193],
            [33, 55, 70],
            [54, 107, 170],
            [18, 60, 104],
            [237, 242, 219],
        ],
        [
            [160, 184, 194],
            [35, 55, 70],
            [54, 105, 168],
            [22, 61, 107],
            [237, 242, 217],
        ],
        [
            [139, 185, 191],
            [31, 55, 84],
            [49, 81, 188],
            [94, 138, 175],
            [236, 240, 219],
        ],
        [
            [150, 179, 188],
            [32, 55, 74],
            [32, 141, 119],
            [20, 58, 80],
            [239, 242, 219],
        ],
        [
            [151, 180, 187],
            [35, 54, 79],
            [36, 139, 121],
            [16, 54, 76],
            [238, 241, 218],
        ],
        [
            [158, 182, 190],
            [35, 55, 70],
            [55, 108, 171],
            [21, 62, 108],
            [235, 243, 219],
        ],
        [
            [158, 182, 190],
            [35, 55, 70],
            [51, 104, 167],
            [23, 62, 108],
            [237, 242, 217],
        ],
        [
            [157, 180, 193],
            [28, 55, 69],
            [46, 114, 167],
            [30, 72, 114],
            [232, 242, 220],
        ],
        [
            [158, 185, 194],
            [36, 57, 75],
            [46, 103, 168],
            [24, 63, 109],
            [237, 242, 217],
        ],
    ],
    "miner": [
        [
            [81, 60, 32],
            [97, 82, 83],
            [54, 61, 62],
            [109, 124, 240],
            [185, 214, 255],
        ],
        [
            [78, 57, 38],
            [86, 83, 77],
            [76, 91, 94],
            [117, 128, 236],
            [197, 222, 255],
        ],
        [
            [73, 59, 37],
            [81, 81, 72],
            [77, 90, 93],
            [118, 131, 239],
            [196, 221, 254],
        ],
        [
            [77, 62, 31],
            [95, 84, 81],
            [54, 60, 64],
            [109, 124, 240],
            [187, 214, 255],
        ],
        [
            [79, 58, 39],
            [83, 79, 75],
            [77, 90, 93],
            [122, 130, 239],
            [196, 221, 254],
        ],
        [
            [75, 59, 30],
            [112, 96, 88],
            [100, 110, 114],
            [129, 148, 247],
            [205, 235, 255],
        ],
        [
            [71, 56, 38],
            [115, 94, 88],
            [101, 109, 113],
            [133, 149, 249],
            [198, 231, 255],
        ],
        [
            [75, 59, 30],
            [112, 95, 89],
            [99, 109, 113],
            [126, 145, 250],
            [206, 241, 255],
        ],
        [
            [70, 55, 37],
            [115, 94, 88],
            [101, 109, 113],
            [131, 147, 247],
            [198, 231, 255],
        ],
    ],
    "skeleton_barrel": [
        [
            [255, 213, 147],
            [254, 218, 142],
            [68, 79, 87],
            [119, 135, 167],
            [49, 81, 133],
        ],
        [
            [255, 220, 137],
            [255, 223, 140],
            [68, 72, 81],
            [92, 105, 126],
            [60, 95, 140],
        ],
        [
            [246, 219, 142],
            [250, 220, 151],
            [69, 73, 75],
            [87, 97, 114],
            [60, 89, 137],
        ],
        [
            [255, 214, 144],
            [253, 227, 147],
            [67, 72, 78],
            [97, 105, 127],
            [49, 88, 121],
        ],
        [
            [255, 213, 141],
            [250, 224, 144],
            [67, 72, 78],
            [97, 105, 127],
            [49, 88, 121],
        ],
        [
            [251, 214, 141],
            [252, 226, 146],
            [69, 71, 78],
            [99, 108, 123],
            [55, 89, 123],
        ],
    ],
    "wall_breakers": [
        [
            [75, 97, 139],
            [68, 63, 62],
            [77, 72, 71],
            [137, 134, 87],
            [127, 128, 49],
        ],
        [
            [87, 101, 140],
            [60, 66, 75],
            [66, 69, 69],
            [151, 152, 100],
            [129, 130, 51],
        ],
        [
            [76, 94, 135],
            [45, 42, 49],
            [66, 66, 64],
            [137, 140, 117],
            [128, 132, 52],
        ],
        [
            [89, 95, 143],
            [41, 44, 55],
            [90, 94, 96],
            [166, 174, 82],
            [127, 132, 49],
        ],
        [
            [87, 97, 141],
            [43, 44, 54],
            [92, 93, 98],
            [170, 173, 82],
            [127, 132, 49],
        ],
    ],
    "snowball": [
      [[197,159,109],
[248,227,187],
[219,186,155],
[196,192,168],
[134,82,47],], [[195,157,107],
[248,227,187],
[216,183,152],
[196,192,168],
[130,78,43],],[[205,167,122],
[247,230,190],
[218,181,147],
[199,191,172],
[98,66,38],], [
            [197, 154, 113],
            [250, 231, 186],
            [215, 189, 157],
            [202, 190, 170],
            [142, 74, 45],
        ],
    ],
    "princess": [
       [[173,163,102],
[102,127,141],
[117,122,149],
[101,131,190],
[51,54,91],],[[143,159,111],
[109,117,139],
[121,138,168],
[104,129,196],
[55,61,97],], [
            [140, 160, 109],
            [107, 115, 137],
            [119, 139, 168],
            [110, 136, 200],
            [56, 59, 96],
        ],
    ],
    "tombstone": [
          [[104,88,25],
[107,127,115],
[187,194,145],
[110,123,62],
[147,162,108],],[[101,87,26],
[147,156,114],
[170,186,129],
[105,118,64],
[141,158,115],],  [
            [105, 87, 24],
            [139, 168, 148],
            [160, 169, 120],
            [107, 117, 64],
            [143, 159, 97],
        ],
    ],
    "royal_delivery": [
      [[117,110,95],
[75,142,239],
[29,64,122],
[69,104,176],
[118,98,88],], [[117,110,89],
[75,142,239],
[26,61,119],
[69,104,176],
[120,100,90],],[[115,111,89],
[77,141,239],
[26,61,119],
[70,105,177],
[115,97,87],], [
            [166, 158, 158],
            [63, 129, 235],
            [7, 52, 105],
            [59, 98, 177],
            [120, 98, 86],
        ],
    ],
    "hog": [
      [[42,95,146],
[20,27,38],
[17,27,39],
[0,2,22],
[115,92,64],],  [
            [41, 93, 148],
            [21, 28, 39],
            [18, 27, 42],
            [0, 2, 22],
            [120, 95, 67],
        ],
        [
            [44, 97, 150],
            [20, 27, 38],
            [17, 27, 39],
            [0, 2, 22],
            [117, 92, 64],
        ],
    ],
    "earthquake": [
           [[74,79,56],
[68,77,65],
[40,65,71],
[71,106,135],
[41,54,70],], [[74,79,56],
[68,77,63],
[44,65,69],
[71,105,137],
[41,55,69],],[
            [72, 80, 54],
            [66, 78, 65],
            [32, 47, 50],
            [86, 131, 153],
            [34, 52, 66],
        ],
        [
            [74, 79, 54],
            [67, 79, 66],
            [29, 44, 47],
            [86, 131, 153],
            [38, 56, 70],
        ],
    ],
    "mortar": [
       [[222,206,177],
[184,170,150],
[123,93,32],
[132,140,139],
[133,135,128],],[[227,207,177],
[183,158,151],
[126,95,37],
[225,223,219],
[136,141,124],],[[217,203,183],
[182,168,134],
[141,95,35],
[168,172,174],
[94,141,168],], [
            [217, 203, 183],
            [182, 168, 134],
            [141, 95, 35],
            [168, 174, 169],
            [94, 141, 168],
        ],
    ],
    "log": [
      [[201,188,177],
[85,138,182],
[10,32,56],
[17,52,71],
[218,223,229],],[[196,189,174],
[86,137,181],
[10,31,57],
[16,50,72],
[221,226,232],], [[199,194,161],
[100,134,181],
[0,35,58],
[20,47,75],
[217,218,213],], [[197,189,163],
[100,135,180],
[0,36,59],
[20,49,77],
[216,217,212],],[
            [189, 195, 162],
            [100, 135, 180],
            [0, 35, 58],
            [24, 53, 81],
            [221, 222, 217],
        ],
    ],
    "tesla": [
         [[163,101,48],
[209,151,87],
[84,61,52],
[195,97,36],
[90,130,221],], [[161,101,48],
[191,129,76],
[91,61,48],
[154,93,51],
[65,123,246],],[[163,101,48],
[191,129,76],
[100,62,51],
[152,93,51],
[67,122,246],], [[161,100,49],
[192,130,77],
[96,64,49],
[152,93,51],
[67,126,246],], [[163,98,46],
[194,126,71],
[88,58,57],
[177,88,28],
[61,130,242],],  [[161,100,44],
[192,126,71],
[84,55,51],
[177,90,25],
[61,128,238],],[[165,101,46],
[192,126,71],
[84,52,56],
[175,88,28],
[61,128,240],], [[161,99,46],
[192,128,68],
[88,54,58],
[175,89,26],
[61,128,240],],[[165,100,48],
[211,148,91],
[82,62,52],
[195,97,36],
[90,130,221],], [[161,100,44],
[212,152,85],
[86,61,52],
[194,96,35],
[90,130,221],], [[163,101,48],
[192,130,77],
[100,62,51],
[152,93,51],
[67,126,246],],
    ],
    "poison": [
       [[4,20,66],
[42,107,231],
[85,126,225],
[108,170,254],
[61,135,231],],[[4,19,69],
[40,107,219],
[121,150,231],
[99,115,255],
[59,133,223],], [[2,19,69],
[45,115,236],
[21,83,201],
[39,149,248],
[59,162,255],],
    ],
    "royal_hogs": [
       [[125,68,0],
[75,63,63],
[194,190,193],
[99,96,145],
[59,47,6],], [[114,65,0],
[67,60,57],
[199,194,195],
[109,111,145],
[61,41,17],], [[124,67,0],
[76,64,64],
[192,188,191],
[103,100,149],
[56,45,2],],[[118,69,0],
[74,64,64],
[192,191,193],
[103,100,149],
[58,47,4],],[[119,67,5],
[76,64,64],
[196,193,194],
[108,115,142],
[56,39,13],],[[123,67,2],
[76,64,64],
[196,193,194],
[108,115,142],
[56,39,13],], [[123,69,7],
[78,66,66],
[197,194,195],
[110,117,144],
[58,41,15],], [[123,65,7],
[70,61,58],
[182,179,178],
[114,113,162],
[60,38,13],], [[121,66,7],
[74,67,59],
[187,182,183],
[106,109,154],
[58,40,11],],
    ],
    "ram_rider": [
        [[0,129,163],
[129,240,252],
[0,22,78],
[98,106,115],
[92,133,193],],[[0,114,139],
[127,236,253],
[0,25,103],
[105,107,114],
[46,135,226],],  [[0,112,132],
[129,238,255],
[0,25,103],
[103,108,114],
[51,141,229],],[[4,115,136],
[127,236,253],
[0,25,103],
[103,107,116],
[46,136,224],], [[1,115,140],
[128,238,253],
[0,25,100],
[103,108,114],
[49,142,229],], [[6,131,161],
[128,246,255],
[0,33,83],
[93,100,111],
[41,136,237],], [[10,128,161],
[129,247,255],
[0,35,84],
[92,99,110],
[39,136,237],],[[13,132,161],
[130,244,255],
[0,34,83],
[96,101,112],
[39,136,237],],[[0,120,130],
[128,237,254],
[0,26,101],
[102,107,113],
[46,136,224],], [[0,114,134],
[129,238,255],
[0,26,104],
[99,106,112],
[43,136,223],],[[0,116,134],
[125,239,250],
[0,23,98],
[103,108,114],
[47,141,231],],[[5,119,130],
[126,239,253],
[0,26,98],
[97,108,116],
[44,137,224],], [[0,117,137],
[128,237,254],
[0,24,102],
[103,108,114],
[42,137,224],],[[2,118,129],
[127,236,253],
[0,22,100],
[99,109,113],
[49,142,229],],
    ],
    "inferno_tower": [
        [[70,93,255],
[110,54,104],
[146,160,240],
[108,119,168],
[105,91,173],],  [[72,96,255],
[110,54,109],
[148,164,244],
[110,121,170],
[104,90,172],], [[75,93,255],
[106,68,99],
[175,190,255],
[107,110,167],
[109,91,165],],[[71,92,255],
[106,68,99],
[176,191,255],
[108,111,168],
[110,89,164],],[[67,94,255],
[110,56,106],
[149,164,247],
[107,118,167],
[105,91,173],], [[64,101,253],
[111,58,119],
[163,192,255],
[107,109,157],
[106,86,179],], [[64,101,253],
[111,58,119],
[163,192,255],
[103,109,157],
[106,86,179],],
    ],
    "goblin_hut": [
        [[227,203,139],
[74,109,193],
[48,96,141],
[0,0,36],
[20,43,103],],[[226,202,138],
[80,112,198],
[52,99,142],
[0,2,33],
[20,43,103],],[[226,202,138],
[78,112,198],
[50,99,142],
[0,5,38],
[20,45,98],], [[226,202,138],
[80,112,198],
[52,99,142],
[0,1,34],
[20,45,98],],[[221,208,137],
[91,133,209],
[51,115,146],
[0,0,31],
[23,53,97],],[[221,208,137],
[95,137,213],
[51,115,146],
[0,0,31],
[23,53,97],],  [[219,209,137],
[87,134,209],
[51,114,148],
[0,0,31],
[21,55,95],],[[218,208,136],
[91,137,215],
[51,115,146],
[0,0,29],
[23,53,97],],
    ],
    "lightning": [
      [[207,186,151],
[249,227,215],
[163,123,105],
[234,113,36],
[194,87,19],],[[206,189,149],
[247,229,214],
[166,124,104],
[234,117,36],
[190,88,19],], [[238,185,139],
[254,233,219],
[170,122,106],
[235,120,39],
[228,210,173],],[[235,186,142],
[252,233,220],
[174,126,110],
[236,120,37],
[231,211,174],],[[243,204,170],
[245,221,209],
[179,129,113],
[240,119,37],
[204,127,77],],[[241,205,168],
[243,222,208],
[175,130,113],
[242,119,37],
[204,128,75],],[[231,181,139],
[254,235,222],
[174,127,108],
[236,119,38],
[232,212,175],], [[220,184,140],
[234,229,209],
[169,119,103],
[228,112,34],
[197,72,8],], [[222,183,140],
[235,227,208],
[167,118,99],
[232,115,41],
[195,73,8],], [[222,183,140],
[235,227,208],
[167,118,99],
[232,116,39],
[199,72,8],], [[224,183,142],
[238,227,211],
[169,119,103],
[226,113,35],
[197,72,8],],[[222,185,146],
[233,227,210],
[167,117,101],
[232,115,41],
[195,73,8],],
    ],
    "rocket": [
     [[233,232,219],
[153,161,178],
[162,194,212],
[160,236,240],
[74,168,224],], [[236,232,222],
[151,159,176],
[162,194,212],
[161,236,242],
[70,167,229],],[[229,235,216],
[152,159,170],
[161,186,205],
[132,233,249],
[59,158,213],],[[234,235,217],
[152,162,172],
[163,187,204],
[130,234,247],
[59,158,213],],  [[238,234,222],
[150,157,158],
[153,179,191],
[172,230,253],
[70,153,208],],
    ],
    "xbow": [
       [[188,188,164],
[172,184,155],
[171,175,184],
[139,167,152],
[98,175,156],], [[196,192,168],
[181,180,153],
[180,175,176],
[131,166,151],
[84,179,151],],[[196,192,170],
[182,182,153],
[180,175,176],
[133,168,153],
[79,177,148],],
    ],
    "rage": [
     [[239,169,233],
[255,212,255],
[99,49,96],
[122,15,96],
[220,202,239],], [[236,166,237],
[255,211,255],
[99,53,93],
[123,15,99],
[220,202,239],],[[237,170,233],
[255,211,255],
[97,51,91],
[122,15,96],
[218,202,239],],  [[249,150,240],
[255,216,255],
[92,61,91],
[127,21,100],
[217,214,244],],
    ],
    "zap": [
       [[155,124,66],
[191,169,118],
[206,160,108],
[189,160,102],
[158,84,33],], [[153,126,63],
[192,170,119],
[207,158,107],
[192,163,105],
[153,78,29],], [[155,124,66],
[191,170,117],
[208,159,108],
[189,161,100],
[152,78,27],],   [[152,115,60],
[191,166,109],
[224,165,118],
[202,119,48],
[145,83,30],],
    ],
}


PLAY_COORDS = {
    "spell": {
        "left": [(94, 151), (95, 151), (86, 117)],
        "right": [(330, 153), (330, 110)],
    },
    "hog": {
        "left": [(77, 281), (113, 286), (154, 283)],
        "right": [(257, 283), (300, 284), (353, 283)],
    },
    "turret": {
        "left": [(224, 300), (224, 334)],
        "right": [(224, 300), (224, 334)],
    },
    "miner": {
        "left": [(86, 156), (90, 104), (143, 113), (142, 153)],
        "right": [(274, 152), (276, 111), (339, 111), (323, 157)],
    },
    "goblin_barrel": {
        "left": [(115, 134), (115, 134), (60, 96)],
        "right": [(300, 137), (300, 137), (356, 106)],
    },
    "xbow": {
        "left": [(170, 288)],
        "right": [(254, 284)],
    },
    "spawner": {
        "left": [(69, 442), (158, 444), (166, 394)],
        "right": [(247, 396), (264, 440), (343, 442)],
    },
}


def get_play_coords_for_card(vm_index, card_index, side_preference):
    card_data = get_all_card_pixel_data(vm_index)[card_index]

    # get the ID of this card(ram_rider, zap, etc)
    identity = identify_card(card_data)

    # get the grouping of this card (hog, turret, spell, etc)
    group = get_card_group(identity)

    # get the play coords of this grouping
    coords = calculate_play_coords(group, side_preference)

    return identity, coords


def get_card_group(card_id) -> str:
    card_groups: dict[str, list[str]] = {
        "spell": [
            "earthquake",
            "fireball",
            "freeze",
            "poison",
            "arrows",
            "snowball",
            "zap",
            "rocket",
            "lightning",
            "log",
            "tornado",
            "graveyard",
        ],
        "turret": [
            "bomb_tower",
            "cannon",
            "tesla",
            "goblin_cage",
            "inferno_tower",
        ],
        "hog": [
            "battle_ram",
            "wall_breakers",
            "princess",
            "ram_rider",
            "skeleton_barrel",
            "hog",
            "royal_hogs",
        ],
        "miner": [
            "goblin_drill",
            "miner",
        ],
        "goblin_barrel": [
            "goblin_barrel",
        ],
        "xbow": [
            "xbow",
            "mortar",
        ],
        "spawner": [
            "tombstone",
            "goblin_hut",
            "barb_hut",
            "furnace",
        ],
    }

    for group, cards in card_groups.items():
        if card_id in cards:
            return group

    return "No group"


def calculate_play_coords(card_grouping: str, side_preference: str):
    if PLAY_COORDS.get(card_grouping):
        group_datum = PLAY_COORDS[card_grouping]
        if side_preference == "left" and "left" in group_datum:
            return random.choice(group_datum["left"])
        if side_preference == "right" and "right" in group_datum:
            return random.choice(group_datum["right"])
        if "coords" in group_datum:
            return random.choice(group_datum["coords"])

    if side_preference == "left":
        return (random.randint(60, 206), random.randint(281, 456))
    return (random.randint(210, 351), random.randint(281, 456))


def get_all_card_pixel_data(vm_index):
    iar = screenshot(vm_index)
    base_coord_list = [
        [121, 537],
        [130, 547],
        [140, 557],
        [150, 567],
        [160, 576],
    ]

    pixel_lists = []

    for card_index in range(4):
        this_pixel_list = []
        for coord in base_coord_list:
            x = coord[0] + (card_index * 66.6)
            x = int(x)
            y = coord[1]
            this_pixel_list.append(iar[y][x])
        pixel_lists.append(this_pixel_list)

    return pixel_lists


def compare_card_pixels(seen_pixel_data, sentinel_pixel_data):
    for index, seen_pixel in enumerate(seen_pixel_data):
        sentinel_pixel = sentinel_pixel_data[index]
        if not pixel_is_equal(seen_pixel, sentinel_pixel, tol=4):
            return False
    return True


def check_pixel(card_name: str, color_list, card_data) -> str | None:
    if compare_card_pixels(card_data, color_list):
        return card_name.replace("_lists", "")
    return None


def identify_card(card_data):
    max_workers = len(CARD_PIXEL_DATA_DICT)
    with ThreadPoolExecutor(
        max_workers=max_workers, thread_name_prefix="CardIdentifier"
    ) as executor:
        futures = [
            executor.submit(check_pixel, card_name, color_list, card_data)
            for card_name, card_pixel_lists in CARD_PIXEL_DATA_DICT.items()
            for color_list in card_pixel_lists
        ]

        for future in as_completed(futures):
            result = future.result()
            if result is not None:
                return result
        return "unknown"


def print_pixel_data(vm_index, card_index):
    data = get_all_card_pixel_data(vm_index)
    pix_list = data[card_index]
    for p in pix_list:
        print(f"[{p[0]},{p[1]},{p[2]}],")


def card_detection_tester(vm_index):
    print("\n\n--------------")
    card_data = get_all_card_pixel_data(vm_index)
    for i, d in enumerate(card_data):
        id = identify_card(d)
        print(id)
        if id == "unknown":
            print(f"Card index #{i} failed")
            for p in d:
                print(f"[{p[0]},{p[1]},{p[2]}],")
        print("--------------")


if __name__ == "__main__":
    vm_index = 12
    side_preference = "left"

    card_detection_tester(vm_index)
